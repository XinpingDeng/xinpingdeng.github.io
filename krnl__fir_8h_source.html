<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>gxcorr: /data/BALDR_1/den15c/gxcorr/gxcorr/krnl_fir.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">gxcorr
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_61fa3639f67dbf40431b13d81e35ca34.html">gxcorr</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">krnl_fir.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="krnl__fir_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#ifndef _KRNL_FIR_H</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#define _KRNL_FIR_H</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#pragma once</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="gxcorr__utils_8h.html">gxcorr_utils.h</a>&quot;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="gxcorr__constants_8h.html">gxcorr_constants.h</a>&quot;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; </div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Warning: Calculation of these parameters is different for each precision case. Sorry.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160; </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// This is dummy parameter, which is not used in the code itself. It says how many thread-blocks we would like to be resident on single SM (multiprocessor)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a476aa4ee59dfd33db659e0150c31f5dd">   12</a></span>&#160;<span class="preprocessor">#define ACTIVE_BLOCKS 3</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// This is again dummy parameter. It says how many single precision floating point numbers can fit into shared memory available to single block</span></div>
<div class="line"><a name="l00014"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#aa1c480f9a3f7e27a7d7eeddd675a57d0">   14</a></span>&#160;<span class="preprocessor">#define TOT_SM_SIZE 12288</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// This is again dummy parameter which says how many channels are processed per single thread-block. It is actual size of a warp=32.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a303ebea0b4b70a3d4353cae0b3b89239">   16</a></span>&#160;<span class="preprocessor">#define CHANNELS_PER_BLOCK 32</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// note: for Maxwell generation the ACTIVE_BLOCKS could be half of blocks present on single SM as this generation has 96kB of shared memory, but shared memory per block is still 48kB</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160; </div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">// gives number of taps</span></div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">   20</a></span>&#160;<span class="preprocessor">#define TAPS 16</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">// COEFF_SIZE is given by number of taps and channels processed per thread-block COEFF_SIZE=CHANNELS_PER_BLOCK*TAPS=512</span></div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a66e15ca388578473f3ddfe666281ba64">   22</a></span>&#160;<span class="preprocessor">#define COEFF_SIZE 512</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// DATA_SIZE says how many input data elements (in floating point numbers) we want to store in shared memory per thread-block. DATA_SIZE=TOT_SM_SIZE/ACTIVE_BLOCKS=4096; DATA_SIZE=DATA_SIZE-COEFF_SIZE=3584; this is because we need to store coefficients in the shared memory along with the input data. We do not need to divide it by two as it was in case of 32-bit precision because we store both real and imaginary part into one bank via uchar4 data type. </span></div>
<div class="line"><a name="l00024"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#af55149bc1f05cf18af067a302e31e3f9">   24</a></span>&#160;<span class="preprocessor">#define DATA_SIZE 3584</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">// THREADS_PER_BLOCK gives number of threads per thread-block. It could be calculated as such THREADS_PER_BLOCK=MAX_THREADS_PER_SM/ACTIVE_BLOCKS; rounded to nearest lower multiple of 32; In case of Maxwell generation MAX_THREADS_PER_SM=2048, thus THREADS_PER_BLOCK=682.6666, rounding to nearest lower multiple of 32 gives THREADS_PER_BLOCK=672;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a869bf6501bf4809f3de1db59ef2dd914">   26</a></span>&#160;<span class="preprocessor">#define THREADS_PER_BLOCK 672</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// SUBBLOCK_SIZE gives size of the sub-block as given in our article. It is calculated as ratio of DATA_SIZE and THREADS_PER_BLOCK rounded up so SUBBLOCK_SIZE=DATA_SIZE/THREADS_PER_BLOCK=5.3333, rounding up gives SUBBLOCK_SIZE=6;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">   28</a></span>&#160;<span class="preprocessor">#define SUBBLOCK_SIZE 6</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">   30</a></span>&#160;<span class="preprocessor">#define WARP 32</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160; </div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">   32</a></span>&#160;<span class="preprocessor">#define SM_COLUMNS (DATA_SIZE/WARP-TAPS+1)</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160; </div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">   34</a></span>&#160;<span class="preprocessor">#define NWARP (THREADS_PER_BLOCK/WARP)</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> TIN, <span class="keyword">typename</span> TOUT&gt;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a770035bb07aecdf38f77de337643deba">   59</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="krnl__fir_8h.html#a770035bb07aecdf38f77de337643deba">krnl_fir</a>(TIN <span class="keyword">const</span>* __restrict__ d_data, TOUT* d_spectra, <span class="keywordtype">float</span> <span class="keyword">const</span>* __restrict__ d_coeff, <span class="keywordtype">int</span> nSpectra, <span class="keywordtype">int</span> nChannels) {</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">int</span> tx       = threadIdx.x;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordtype">int</span> warpId   = ((int) tx/<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">int</span> localId  = tx - warpId*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordtype">int</span> channelId = blockIdx.x*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordflow">if</span>(channelId &gt;= nChannels){</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keywordtype">int</span> stream = blockIdx.z;  </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  __shared__ TIN   s_data[<a class="code" href="krnl__fir_8h.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>];</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  __shared__ <span class="keywordtype">float</span> s_coeff[<a class="code" href="krnl__fir_8h.html#a66e15ca388578473f3ddfe666281ba64">COEFF_SIZE</a>];</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="comment">// read data, fill DATA_SIZE</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a>; i++){</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordtype">int</span> start_column = warpId*<a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a> + i;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keywordtype">int</span> spectraId = blockIdx.y*<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + start_column; <span class="comment">// SM_COLUMNS = DATA_SIZE/WARP - (TAPS - 1)</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// here assumes that NWARP*SUBBLOCK_SIZE &gt;= SM_COLUMNS + TAPS - 1</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">if</span> ((start_column &lt; (<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1)) &amp;&amp; (spectraId &lt; (nSpectra + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1))) {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      <span class="keywordtype">int</span> s_mempos = start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId; <span class="comment">// fill up DATA_SIZE</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      <span class="keywordtype">int</span> g_mempos = stream*(nSpectra + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1)*nChannels + spectraId*nChannels + channelId;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      s_data[s_mempos] = __ldg(&amp;d_data[g_mempos]);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    }</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">int</span> itemp = (int) (<a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>/<a class="code" href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">NWARP</a>) + 1;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> f=0; f&lt;itemp; f++){</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keywordtype">int</span> start_column = f*<a class="code" href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">NWARP</a> + warpId;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">if</span>(start_column&lt;<a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>){ <span class="comment">// fill up COEFF_SIZE</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      s_coeff[start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]=__ldg(&amp;d_coeff[start_column*nChannels + channelId]);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  __syncthreads();</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160; </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a>; i++){</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordtype">int</span> start_column = warpId*<a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a> + i;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordtype">int</span> spectraId = blockIdx.y*<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + start_column;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">if</span> ((start_column &lt; <a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a>) &amp;&amp; (spectraId &lt; nSpectra)){</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;      <span class="keywordtype">int</span> s_mempos = start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      cuComplex ftemp = {0.0, 0.0};</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="comment">//ftemp.x = 0.0f;</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      <span class="comment">//ftemp.y = 0.0f;</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>; j++){</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    ftemp.x += s_coeff[j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]*((float) s_data[s_mempos + j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>].x);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    ftemp.y += s_coeff[j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]*((float) s_data[s_mempos + j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>].y);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      } <span class="comment">//ntaps</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <span class="keywordtype">int</span> g_mempos = stream*nSpectra*nChannels + spectraId*nChannels + channelId;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;      d_spectra[g_mempos].x = ftemp.x;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      d_spectra[g_mempos].y = ftemp.y;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  } <span class="comment">// number of columns</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="comment">//return;</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;}</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> TIN, <span class="keyword">typename</span> TOUT&gt;</div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="krnl__fir_8h.html#a5c28a221bac7280d5c42fdb4224530f0">  144</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="krnl__fir_8h.html#a5c28a221bac7280d5c42fdb4224530f0">krnl_fir_unpack</a>(TIN <span class="keyword">const</span>*  __restrict__ d_data,</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                <span class="keywordtype">float</span> <span class="keyword">const</span>*   __restrict__ d_coeff,</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                <span class="keywordtype">float</span> <span class="keyword">const</span>*   __restrict__ d_rotate,</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                <span class="keywordtype">int</span> <span class="keyword">const</span>* __restrict__ d_shift,</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                TOUT* d_spectra,</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                <span class="keywordtype">int</span> ntime_extra,</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                <span class="keywordtype">int</span> nSpectra,</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="keywordtype">int</span> nChannels) {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordtype">int</span> tx        = threadIdx.x;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordtype">int</span> warpId    = ((int) tx/<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordtype">int</span> localId   = tx - warpId*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="keywordtype">int</span> channelId = blockIdx.x*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordflow">if</span>(channelId &gt;= nChannels){</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordtype">int</span> stream = blockIdx.z;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="keywordtype">int</span> ant    = stream/2;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  </div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  __shared__ float2 s_data[<a class="code" href="krnl__fir_8h.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a>];</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  __shared__ <span class="keywordtype">float</span>  s_coeff[<a class="code" href="krnl__fir_8h.html#a66e15ca388578473f3ddfe666281ba64">COEFF_SIZE</a>];</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">// read data, fill DATA_SIZE</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a>; i++){</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">int</span> start_column = warpId*<a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a> + i; <span class="comment">// NWARP*SUBBLOCK_SIZE, (THREADS_PER_BLOCK/WARP*SUBBLOCK_SIZE)</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordtype">int</span> spectraId = blockIdx.y*<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + start_column;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span> ((start_column &lt; (<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1)) &amp;&amp; (spectraId &lt; (nSpectra + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1))) {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      <span class="keywordtype">int</span> idx_shift  = ant*(nSpectra+<a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>-1)+spectraId;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      <span class="keywordtype">int</span> idx_rotate = 2*idx_shift;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  </div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <span class="keywordtype">int</span> shift = __ldg(&amp;d_shift[idx_shift]);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      <span class="comment">// if we need fftshift, we can shift phase_rotation and window instead</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      <span class="comment">// not shift input samples here</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      <span class="comment">// only shift cross correlation in the end </span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      <span class="keywordtype">float</span> p0 = __ldg(&amp;d_rotate[idx_rotate]);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      <span class="keywordtype">float</span> p1 = __ldg(&amp;d_rotate[idx_rotate+1]);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="keywordtype">float</span> theta = p0 + channelId*p1;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      <span class="comment">// shift input samples</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      <span class="keywordtype">int</span> g_mempos = stream*((nSpectra + <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a> - 1)*nChannels + 2*ntime_extra) + ntime_extra + spectraId*nChannels + channelId + shift;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;      TIN current = __ldg(&amp;d_data[g_mempos]);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      float2 current_float = {(float)current.x, (<span class="keywordtype">float</span>)current.y};</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      <a class="code" href="gxcorr__utils_8h.html#a4363e017bb5707c7a50f6aa013834dc4">cuRotatePhase</a>(current_float, theta);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      <span class="keywordtype">int</span> s_mempos = start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      s_data[s_mempos] = current_float;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    }</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="keywordtype">int</span> itemp = (int) (<a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>/<a class="code" href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">NWARP</a>) + 1;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> f=0; f&lt;itemp; f++){</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordtype">int</span> start_column = f*<a class="code" href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">NWARP</a> + warpId;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">if</span>(start_column&lt;<a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>){</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      s_coeff[start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]=__ldg(&amp;d_coeff[start_column*nChannels + channelId]);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  __syncthreads();</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160; </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a>; i++){</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordtype">int</span> start_column = warpId*<a class="code" href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a> + i; <span class="comment">// NWARP*SUBBLOCK_SIZE, (THREADS_PER_BLOCK/WARP*SUBBLOCK_SIZE)</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordtype">int</span> spectraId = blockIdx.y*<a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a> + start_column;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> ((start_column &lt; <a class="code" href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a>) &amp;&amp; (spectraId &lt; nSpectra)){</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="keywordtype">int</span> s_mempos = start_column*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      cuComplex ftemp = {0.0, 0.0};</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a>; j++){</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    ftemp.x += s_coeff[j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]*((float) s_data[s_mempos + j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>].x);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    ftemp.y += s_coeff[j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a> + localId]*((float) s_data[s_mempos + j*<a class="code" href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a>].y);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      } <span class="comment">//ntaps</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <span class="keywordtype">int</span> g_mempos = stream*nSpectra*nChannels + spectraId*nChannels + channelId;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;      d_spectra[g_mempos].x = ftemp.x;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      d_spectra[g_mempos].y = ftemp.y;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  } <span class="comment">// number of columns</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  <span class="comment">//return;</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;}</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">//template &lt;typename TIN, typename TOUT&gt;</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">//__global__ void krnl_fir_unpack(TIN const*  __restrict__ d_data,</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">//              float const*   __restrict__ d_coeff,</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">//              float const*   __restrict__ d_rotate,</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">//              int const* __restrict__ d_shift,</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">//              TOUT* d_spectra,</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">//              int ntime_extra,</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">//              int nSpectra,</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">//              int nChannels) {</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">//  int tx        = threadIdx.x;</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">//  int warpId    = ((int) tx/WARP);</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">//  int localId   = tx - warpId*WARP;</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">//  int channelId = blockIdx.x*WARP + localId;</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">//  if(channelId &gt;= nChannels){</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">//    return;</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">//  }</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">//  int stream = blockIdx.z;</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">//  int ant    = stream/2;</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">//  __shared__ float2 s_data[DATA_SIZE];</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">//  __shared__ float  s_coeff[COEFF_SIZE];</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">//  __shared__ int s_shift[SM_COLUMNS + TAPS - 1];</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">//  __shared__ float s_p0[SM_COLUMNS + TAPS - 1];</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">//  __shared__ float s_p1[SM_COLUMNS + TAPS - 1];</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">//  for (int i = 0; i &lt; SUBBLOCK_SIZE; i++){</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">//    int start_column = warpId*SUBBLOCK_SIZE + i; // NWARP*SUBBLOCK_SIZE, (THREADS_PER_BLOCK/WARP*SUBBLOCK_SIZE)</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">//    int spectraId = blockIdx.y*SM_COLUMNS + start_column;</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">//    if ((start_column &lt; (SM_COLUMNS + TAPS - 1)) &amp;&amp; (spectraId &lt; (nSpectra + TAPS - 1))) {</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">//      if(localId == 0){</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">//  int idx_shift  = ant*(nSpectra+TAPS-1)+spectraId;</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">//  int idx_rotate = 2*idx_shift;</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">//  int shift = __ldg(&amp;d_shift[idx_shift]);</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">//  // if we need fftshift, we can shift phase_rotation and window instead</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">//  // not shift input samples here</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">//  // only shift cross correlation in the end </span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">//  float p0 = __ldg(&amp;d_rotate[idx_rotate]);</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">//  float p1 = __ldg(&amp;d_rotate[idx_rotate+1]);</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">//  s_shift[start_column] = shift;</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">//  s_p0[start_column] = p0;</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">//  s_p1[start_column] = p1;</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">//      }</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">//    }</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">//  }</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">//  __syncthreads();</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">//  // read data, fill DATA_SIZE</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">//  for (int i = 0; i &lt; SUBBLOCK_SIZE; i++){</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">//    int start_column = warpId*SUBBLOCK_SIZE + i; // NWARP*SUBBLOCK_SIZE, (THREADS_PER_BLOCK/WARP*SUBBLOCK_SIZE)</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">//    int spectraId = blockIdx.y*SM_COLUMNS + start_column;</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">//    if ((start_column &lt; (SM_COLUMNS + TAPS - 1)) &amp;&amp; (spectraId &lt; (nSpectra + TAPS - 1))) {</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">//      int shift = s_shift[start_column];</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">//      // if we need fftshift, we can shift phase_rotation and window instead</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">//      // not shift input samples here</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">//      // only shift cross correlation in the end </span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">//      float p0 = s_p0[start_column];</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">//      float p1 = s_p1[start_column];</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">//      float theta = p0 + channelId*p1;</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">//    </span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">//      // shift input samples</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">//      int g_mempos = stream*((nSpectra + TAPS - 1)*nChannels + 2*ntime_extra) + ntime_extra + spectraId*nChannels + channelId + shift;</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">//      </span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">//      TIN current = __ldg(&amp;d_data[g_mempos]);</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">//      float2 current_float = {(float)current.x, (float)current.y};</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">//      cuRotatePhase(current_float, theta);</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">//      </span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">//      int s_mempos = start_column*WARP + localId;</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">//      s_data[s_mempos] = current_float;</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">//    }</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">//  }</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">//  int itemp = (int) (TAPS/NWARP) + 1;</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">//  for(int f=0; f&lt;itemp; f++){</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">//    int start_column = f*NWARP + warpId;</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">//    if(start_column&lt;TAPS){</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">//      s_coeff[start_column*WARP + localId]=__ldg(&amp;d_coeff[start_column*nChannels + channelId]);</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">//    }</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">//  }</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">//  </span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">//  __syncthreads();</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">//  for (int i = 0; i &lt; SUBBLOCK_SIZE; i++){</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">//    int start_column = warpId*SUBBLOCK_SIZE + i; // NWARP*SUBBLOCK_SIZE, (THREADS_PER_BLOCK/WARP*SUBBLOCK_SIZE)</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">//    int spectraId = blockIdx.y*SM_COLUMNS + start_column;</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">//    </span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">//    if ((start_column &lt; SM_COLUMNS) &amp;&amp; (spectraId &lt; nSpectra)){</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">//      int s_mempos = start_column*WARP + localId;</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">//      cuComplex ftemp = {0.0, 0.0};</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">//      </span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">//      for (int j = 0; j &lt; TAPS; j++){</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">//  ftemp.x += s_coeff[j*WARP + localId]*((float) s_data[s_mempos + j*WARP].x);</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">//  ftemp.y += s_coeff[j*WARP + localId]*((float) s_data[s_mempos + j*WARP].y);</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">//      } //ntaps</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">//      int g_mempos = stream*nSpectra*nChannels + spectraId*nChannels + channelId;</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">//      d_spectra[g_mempos].x = ftemp.x;</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">//      d_spectra[g_mempos].y = ftemp.y;</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">//    } //if</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">//  } // number of columns</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">//  //return;</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">//}</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="ttc" id="agxcorr__constants_8h_html"><div class="ttname"><a href="gxcorr__constants_8h.html">gxcorr_constants.h</a></div></div>
<div class="ttc" id="agxcorr__utils_8h_html"><div class="ttname"><a href="gxcorr__utils_8h.html">gxcorr_utils.h</a></div></div>
<div class="ttc" id="agxcorr__utils_8h_html_a4363e017bb5707c7a50f6aa013834dc4"><div class="ttname"><a href="gxcorr__utils_8h.html#a4363e017bb5707c7a50f6aa013834dc4">cuRotatePhase</a></div><div class="ttdeci">__host__ static __device__ void cuRotatePhase(cuComplex &amp;x, float theta)</div><div class="ttdef"><b>Definition:</b> gxcorr_utils.h:30</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a5c28a221bac7280d5c42fdb4224530f0"><div class="ttname"><a href="krnl__fir_8h.html#a5c28a221bac7280d5c42fdb4224530f0">krnl_fir_unpack</a></div><div class="ttdeci">__global__ void krnl_fir_unpack(TIN const *__restrict__ d_data, float const *__restrict__ d_coeff, float const *__restrict__ d_rotate, int const *__restrict__ d_shift, TOUT *d_spectra, int ntime_extra, int nSpectra, int nChannels)</div><div class="ttdoc">A overloaded template kernel to merge FIR with unpack.</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:144</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a66e15ca388578473f3ddfe666281ba64"><div class="ttname"><a href="krnl__fir_8h.html#a66e15ca388578473f3ddfe666281ba64">COEFF_SIZE</a></div><div class="ttdeci">#define COEFF_SIZE</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:22</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a6d319563dac46bc6621c442ed3af5380"><div class="ttname"><a href="krnl__fir_8h.html#a6d319563dac46bc6621c442ed3af5380">WARP</a></div><div class="ttdeci">#define WARP</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:30</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a770035bb07aecdf38f77de337643deba"><div class="ttname"><a href="krnl__fir_8h.html#a770035bb07aecdf38f77de337643deba">krnl_fir</a></div><div class="ttdeci">__global__ void krnl_fir(TIN const *__restrict__ d_data, TOUT *d_spectra, float const *__restrict__ d_coeff, int nSpectra, int nChannels)</div><div class="ttdoc">A overloaded template kernel to apply FIR to input raw data.</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:59</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a8b092f1ff6993086ef2e32a8fccde801"><div class="ttname"><a href="krnl__fir_8h.html#a8b092f1ff6993086ef2e32a8fccde801">NWARP</a></div><div class="ttdeci">#define NWARP</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:34</div></div>
<div class="ttc" id="akrnl__fir_8h_html_a8dbaf82f0d099633ea34d1e5b6e36f8c"><div class="ttname"><a href="krnl__fir_8h.html#a8dbaf82f0d099633ea34d1e5b6e36f8c">SM_COLUMNS</a></div><div class="ttdeci">#define SM_COLUMNS</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:32</div></div>
<div class="ttc" id="akrnl__fir_8h_html_ae03af9ee5754e9f116ec974f8b615bee"><div class="ttname"><a href="krnl__fir_8h.html#ae03af9ee5754e9f116ec974f8b615bee">TAPS</a></div><div class="ttdeci">#define TAPS</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:20</div></div>
<div class="ttc" id="akrnl__fir_8h_html_aee03863853c4db98c72d31042e340eb0"><div class="ttname"><a href="krnl__fir_8h.html#aee03863853c4db98c72d31042e340eb0">SUBBLOCK_SIZE</a></div><div class="ttdeci">#define SUBBLOCK_SIZE</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:28</div></div>
<div class="ttc" id="akrnl__fir_8h_html_af55149bc1f05cf18af067a302e31e3f9"><div class="ttname"><a href="krnl__fir_8h.html#af55149bc1f05cf18af067a302e31e3f9">DATA_SIZE</a></div><div class="ttdeci">#define DATA_SIZE</div><div class="ttdef"><b>Definition:</b> krnl_fir.h:24</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
